#!/usr/bin/groovy
@Library('pipelib@v0.2.4') _

node ("sl61") {

  stage("PZSVC Deps Security Scans") {
    deleteDir()
    sh "mkdir -p pzsvc-ndwi-repo"
    dir("pzsvc-ndwi-repo") {

      git url: "https://github.com/venicegeo/pzsvc-ndwi-py.git", branch: "pipeline-refactor"
        sh "git submodule init"
        sh "git submodule update --recursive"
        withCredentials([[$class: 'StringBinding', credentialsId: '978C467A-2B26-47AE-AD2F-4AFD5A4AF695', variable: 'THREADFIXKEY']]) {
          dir("./conda-recipes/vendor") {
            parallel(
              gippyscan: {
                dir("./gippy") {
                  // **Fortify**
                  sh "/opt/hp_fortify_sca/bin/sourceanalyzer -b ${env.BUILD_NUMBER} ./gippy/{*.py,**/*.py} -exclude **/test/* -exclude **/docker/*"
                  sh "/opt/hp_fortify_sca/bin/sourceanalyzer -b ${env.BUILD_NUMBER}  -scan -Xmx8G -f fortifyResults-${env.BUILD_NUMBER}.fpr"
                  sh "/bin/curl -v --insecure -H 'Accept: application/json' -X POST --form file=@fortifyResults-${env.BUILD_NUMBER}.fpr https://threadfix.devops.geointservices.io/rest/applications/93/upload?apiKey=$THREADFIXKEY"
                  // **OWASP**
                  sh '/opt/dependency-check/bin/dependency-check.sh --project "Gippy" --scan "." --format "XML" --enableExperimental'
                  sh "/bin/curl -v --insecure -H 'Accept: application/json' -X POST --form file=@dependency-check-report.xml https://threadfix.devops.geointservices.io/rest/applications/93/upload?apiKey=$THREADFIXKEY"
                }
              },
              bfalgscan: {
                dir("./bfalg-ndwi") {
                  // **Fortify**
                  sh "/opt/hp_fortify_sca/bin/sourceanalyzer -b ${env.BUILD_NUMBER} ./bfalg_ndwi/{*.py,**/*.py} -exclude **/test/* -exclude **/deploy/*"
                  sh "/opt/hp_fortify_sca/bin/sourceanalyzer -b ${env.BUILD_NUMBER}  -scan -Xmx8G -f fortifyResults-${env.BUILD_NUMBER}.fpr"
                  sh "/bin/curl -v --insecure -H 'Accept: application/json' -X POST --form file=@fortifyResults-${env.BUILD_NUMBER}.fpr https://threadfix.devops.geointservices.io/rest/applications/92/upload?apiKey=$THREADFIXKEY"
                  // **OWASP**
                  sh '/opt/dependency-check/bin/dependency-check.sh --project "Bfalg-ndwi" --scan "." --format "XML" --enableExperimental'
                  sh "/bin/curl -v --insecure -H 'Accept: application/json' -X POST --form file=@dependency-check-report.xml https://threadfix.devops.geointservices.io/rest/applications/92/upload?apiKey=$THREADFIXKEY"
                }
              },
              beachfront: {
                dir("./beachfront-py") {
                  // **Fortify**
                  sh "/opt/hp_fortify_sca/bin/sourceanalyzer -b ${env.BUILD_NUMBER} ./beachfront/{*.py,**/*.py} -exclude **/test/*"
                  sh "/opt/hp_fortify_sca/bin/sourceanalyzer -b ${env.BUILD_NUMBER}  -scan -Xmx8G -f fortifyResults-${env.BUILD_NUMBER}.fpr"
                  sh "/bin/curl -v --insecure -H 'Accept: application/json' -X POST --form file=@fortifyResults-${env.BUILD_NUMBER}.fpr https://threadfix.devops.geointservices.io/rest/applications/91/upload?apiKey=$THREADFIXKEY"
                  // **OWASP**
                  sh '/opt/dependency-check/bin/dependency-check.sh --project "Beachfront Py" --scan "." --format "XML" --enableExperimental'
                  sh "/bin/curl -v --insecure -H 'Accept: application/json' -X POST --form file=@dependency-check-report.xml https://threadfix.devops.geointservices.io/rest/applications/91/upload?apiKey=$THREADFIXKEY"
                }
              },
              pzsvcexec: {
                dir("./pzsvc-exec") {
                 // **OWASP**
                 sh '/opt/dependency-check/bin/dependency-check.sh --project "PSVC Exec" --scan "." --format "XML" --enableExperimental'
                sh "/bin/curl -v --insecure -H 'Accept: application/json' -X POST --form file=@dependency-check-report.xml https://threadfix.devops.geointservices.io/rest/applications/94/upload?apiKey=$THREADFIXKEY"
                }
              }
            )
          }
        }
    }
  }

  stage("PZSVC Scans Pass/Fail") {
    sh "mkdir -p sspf-repo"
    dir("./sspf-repo") {
      git url: "https://github.com/venicegeo/sspf"
      dir("./sspf") {
        withCredentials([[$class: 'StringBinding', credentialsId: '978C467A-2B26-47AE-AD2F-4AFD5A4AF695', variable: 'THREADFIXKEY']]) {
          sh "curl  --fail --silent 'https://threadfix.devops.geointservices.io/rest/applications/94?apiKey=$THREADFIXKEY' | ./sspf.py"
          sh "curl  --fail --silent 'https://threadfix.devops.geointservices.io/rest/applications/93?apiKey=$THREADFIXKEY' | ./sspf.py"
          sh "curl  --fail --silent 'https://threadfix.devops.geointservices.io/rest/applications/92?apiKey=$THREADFIXKEY' | ./sspf.py"
          sh "curl  --fail --silent 'https://threadfix.devops.geointservices.io/rest/applications/91?apiKey=$THREADFIXKEY' | ./sspf.py"
        }
      }
    }
  }


  stage("Conda Build") {
    dir("pzsvc-ndwi-repo/docker") {
      sh "docker-compose rm -f --all"
      sh "docker-compose up --build --no-color"
    }
  }

  stage("Nexus Deploy pzsvc-ndwi") {
    withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'ldap_baxtersh', usernameVariable: 'NEXUSUSER', passwordVariable: 'NEXUSPASS']]) {
        dir("pzsvc-ndwi-repo/docker/out/conda-bld") {
        sh """
           for f in \$(find . -type f); do
              curl -T "\$f" -u \$NEXUSUSER:\$NEXUSPASS https://nexus.devops.geointservices.io/content/sites/beachfront-conda/\$f
           done
           """
      }
    }
  }

  stage("L2 Deploy") {
    // Do Cloudfoundry Push
    dir("pzsvc-ndwi-repo") {
      if(!fileExists('.cf')) {
        sh "mkdir -p .cf"
      }
      withEnv(['CF_HOME=.cf']) {
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'ldap_baxtersh', usernameVariable: 'CFUSER', passwordVariable: 'CFPASS']]) {
          sh "cf api http://api.system.dev.east.paas.geointservices.io"
          sh "cf auth  \$CFUSER \$CFPASS"
          sh "cf target -o Optimus -s pz-dev"
          sh "cf push -b https://github.com/cloudfoundry/buildpack-python.git --health-check-type none"
        }
      }
    // We can use this when pipelib 0.3.0 is done
    //  cfPush {
    //    cfTarget = 'dev'
    //    cfOrg = 'Optimus'
    //    cfProject = 'pz'
    //    cfApi = 'https://api.system.dev.east.paas.geointservices.io'
    //    cfApp = 'pzsvc-ndwi'
    //    cfDomain = 'east.paas.geointservices.io'
    //  }
    }
  }
}

